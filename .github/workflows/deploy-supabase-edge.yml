name: Deploy Supabase Edge Function

on:
  push:
    branches: [main]
    paths:
      - supabase/functions/make-server-139017f8/**
      - .github/workflows/deploy-supabase-edge.yml
  workflow_dispatch:

jobs:
  check_secrets:
    runs-on: ubuntu-latest
    outputs:
      ready: ${{ steps.check.outputs.ready }}
    steps:
      - name: Check required secrets
        id: check
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          missing=0
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "::warning title=Missing secret::SUPABASE_ACCESS_TOKEN is not set (Repo Settings → Secrets and variables → Actions)."
            missing=1
          fi
          if [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "::warning title=Missing secret::SUPABASE_PROJECT_REF is not set (your Supabase project ref)."
            missing=1
          fi
          if [ -z "$SUPABASE_URL" ]; then
            echo "::warning title=Missing secret::SUPABASE_URL is not set (e.g. https://<project-ref>.supabase.co)."
            missing=1
          fi
          if [ -z "$SUPABASE_ANON_KEY" ]; then
            echo "::warning title=Missing secret::SUPABASE_ANON_KEY is not set (use the project's anon key)."
            missing=1
          fi

          if [ "$missing" -ne 0 ]; then
            echo "ready=false" >> "$GITHUB_OUTPUT"
            echo "Secrets missing; skipping deploy." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          echo "ready=true" >> "$GITHUB_OUTPUT"

  deploy:
    needs: [check_secrets]
    if: ${{ needs.check_secrets.outputs.ready == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@v1

      - name: Deploy function
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          supabase login --token "$SUPABASE_ACCESS_TOKEN"
          supabase functions deploy make-server-139017f8 --project-ref "$SUPABASE_PROJECT_REF"

      - name: Smoke test
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          curl -fsS \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            "$SUPABASE_URL/functions/v1/make-server-139017f8/health" \
            >/dev/null
